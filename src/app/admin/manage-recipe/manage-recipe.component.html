<mat-sidenav-container class="admin-container">
  <mat-sidenav mode="side" [opened]="true" class="admin-sidenav shadow">
    <app-sidebar></app-sidebar>
  </mat-sidenav>

  <mat-sidenav-content>
    <!-- Top Toolbar -->
    <mat-toolbar class="top-toolbar border-bottom bg-white">
      <button mat-icon-button routerLink="/admin/recipe-list">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <span class="ms-2 fw-bold">{{ id ? 'Update Recipe' : 'Add New Recipe' }}</span>
    </mat-toolbar>

    <div class="page-content p-4 d-flex justify-content-center">
      <mat-card class="form-card shadow-sm border-0 w-100" style="max-width: 1000px;">
        <mat-card-header class="mb-4">
          <mat-card-title class="fw-bold fs-3">{{ id ? 'Modify Recipe Details' : 'Enter Recipe Details' }}</mat-card-title>
          <mat-card-subtitle>Fill in all the information below to {{ id ? 'update' : 'publish' }} a recipe.</mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <form [formGroup]="recipeForm" (ngSubmit)="submitRecipe()">
            <div class="recipe-preview text-center mb-5" *ngIf="previewImage">
              <div class="preview-img-container shadow-sm mx-auto">
                <img [src]="previewImage" alt="Recipe Preview" class="preview-img">
              </div>
              <p class="text-muted small mt-2">Image Preview</p>
            </div>

            <div class="row g-4">
              <!-- Left Side -->
              <div class="col-lg-6">
                <mat-form-field appearance="outline" class="w-100 mb-2">
                  <mat-label>Recipe Name</mat-label>
                  <input matInput formControlName="name" placeholder="Ex. Spicy Arabiata Pasta">
                  <mat-icon matPrefix class="me-2">restaurant</mat-icon>
                  <mat-error *ngIf="recipeForm.get('name')?.hasError('required')">Name is required</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-100 mb-2">
                  <mat-label>Preparation Time (Minutes)</mat-label>
                  <input matInput type="number" formControlName="prepTimeMinutes" placeholder="Ex. 15">
                  <mat-icon matPrefix class="me-2">timer</mat-icon>
                  <mat-error *ngIf="recipeForm.get('prepTimeMinutes')?.hasError('required')">Prep time is required</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-100 mb-2">
                  <mat-label>Image URL</mat-label>
                  <input matInput formControlName="image" placeholder="https://example.com/image.jpg">
                  <mat-icon matPrefix class="me-2">image</mat-icon>
                  <mat-error *ngIf="recipeForm.get('image')?.hasError('required')">Image URL is required</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-100 mb-2">
                  <mat-label>Cuisine Type</mat-label>
                  <mat-select formControlName="cuisine">
                    @for (cuisine of cusineArray; track $index) {
                      <mat-option [value]="cuisine">{{cuisine}}</mat-option>
                    }
                  </mat-select>
                  <mat-icon matPrefix class="me-2">public</mat-icon>
                  <mat-error *ngIf="recipeForm.get('cuisine')?.hasError('required')">Please select a cuisine</mat-error>
                </mat-form-field>

                <!-- Ingredients -->
                <div class="dynamic-list-section mt-3">
                  <h5 class="fw-bold mb-3 d-flex align-items-center">
                    <mat-icon class="me-2 text-primary">shopping_basket</mat-icon> Ingredients
                  </h5>
                  <div class="d-flex gap-2 mb-3">
                    <mat-form-field appearance="outline" class="flex-grow-1">
                      <mat-label>Add Ingredient</mat-label>
                      <input matInput #ingredient placeholder="Ex. 2 cups Flour" (keyup.enter)="addIngredients(ingredient)">
                    </mat-form-field>
                    <button mat-mini-fab color="primary" type="button" (click)="addIngredients(ingredient)">
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>
                  
                  <mat-chip-set class="mb-4">
                    @for (item of ingredientArray; track $index) {
                      <mat-chip removable (removed)="removeIngredient(item)">
                        {{item}}
                        <mat-icon matChipRemove>cancel</mat-icon>
                      </mat-chip>
                    }
                  </mat-chip-set>
                  <div class="text-danger small mb-3" *ngIf="ingredientArray.length === 0">At least one ingredient is required.</div>
                </div>
              </div>

              <!-- Right Side -->
              <div class="col-lg-6">
                <mat-form-field appearance="outline" class="w-100 mb-2">
                  <mat-label>Servings</mat-label>
                  <input matInput type="number" formControlName="servings" placeholder="Ex. 4">
                  <mat-icon matPrefix class="me-2">groups</mat-icon>
                  <mat-error *ngIf="recipeForm.get('servings')?.hasError('required')">Servings is required</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-100 mb-2">
                  <mat-label>Cooking Time (Minutes)</mat-label>
                  <input matInput type="number" formControlName="cookTimeMinutes" placeholder="Ex. 30">
                  <mat-icon matPrefix class="me-2">outdoor_grill</mat-icon>
                  <mat-error *ngIf="recipeForm.get('cookTimeMinutes')?.hasError('required')">Cooking time is required</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-100 mb-2">
                  <mat-label>Calories Per Serving</mat-label>
                  <input matInput type="number" formControlName="caloriesPerServing" placeholder="Ex. 350">
                  <mat-icon matPrefix class="me-2">local_fire_department</mat-icon>
                  <mat-error *ngIf="recipeForm.get('caloriesPerServing')?.hasError('required')">Calories is required</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-100 mb-2">
                  <mat-label>Difficulty Level</mat-label>
                  <mat-select formControlName="difficulty">
                    <mat-option value="Easy">Easy</mat-option>
                    <mat-option value="Medium">Medium</mat-option>
                    <mat-option value="Hard">Hard</mat-option>
                  </mat-select>
                  <mat-icon matPrefix class="me-2">equalizer</mat-icon>
                  <mat-error *ngIf="recipeForm.get('difficulty')?.hasError('required')">Difficulty is required</mat-error>
                </mat-form-field>

                <!-- Instructions -->
                <div class="dynamic-list-section mt-3">
                  <h5 class="fw-bold mb-3 d-flex align-items-center">
                    <mat-icon class="me-2 text-primary">menu_book</mat-icon> Instructions
                  </h5>
                  <div class="d-flex gap-2 mb-3">
                    <mat-form-field appearance="outline" class="flex-grow-1">
                      <mat-label>Add Step</mat-label>
                      <textarea matInput #instruction placeholder="Ex. Preheat oven to 350Â°F" rows="1" (keyup.enter)="addInstruction(instruction)"></textarea>
                    </mat-form-field>
                    <button mat-mini-fab color="primary" type="button" (click)="addInstruction(instruction)">
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>
                  
                  <div class="instruction-list mb-4">
                    @for (item of instructionArray; track $index) {
                      <div class="d-flex align-items-center justify-content-between p-2 mb-2 bg-light rounded border">
                        <span class="small text-truncate pe-2">{{$index + 1}}. {{item}}</span>
                        <button mat-icon-button color="warn" type="button" (click)="removeInstruction(item)">
                          <mat-icon>delete_outline</mat-icon>
                        </button>
                      </div>
                    }
                  </div>
                  <div class="text-danger small mb-3" *ngIf="instructionArray.length === 0">At least one instruction step is required.</div>
                </div>
              </div>
            </div>

            <!-- Meal Types -->
            <div class="meal-type-section mt-4 p-4 rounded bg-light border border-opacity-10">
              <h5 class="fw-bold mb-3">Target Meal Types</h5>
              <div class="d-flex flex-wrap gap-3">
                @for (meal of mealTypeArray; track $index) {
                  <div class="meal-checkbox-wrapper">
                    <mat-checkbox [name]="meal" (change)="mealTypeSelect($event)" [checked]="mealArray.includes(meal)">
                      {{meal}}
                    </mat-checkbox>
                  </div>
                }
              </div>
              
              <div class="mt-3" *ngIf="mealArray.length > 0">
                <span class="text-muted small me-2">Selected:</span>
                <mat-chip-set class="d-inline-flex">
                  @for (item of mealArray; track $index) {
                    <mat-chip highlighted color="accent" removable (removed)="removeMealType(item)">
                      {{item}}
                      <mat-icon matChipRemove>cancel</mat-icon>
                    </mat-chip>
                  }
                </mat-chip-set>
              </div>
              <div class="text-danger small mt-2" *ngIf="mealArray.length === 0">At least one meal type is required.</div>
            </div>

            <!-- Submit Actions -->
            <div class="actions-section mt-5 d-flex justify-content-center gap-3">
              <button mat-stroked-button color="warn" type="button" routerLink="/admin/recipe-list" class="px-5 py-2">CANCEL</button>
              
              <button mat-raised-button color="primary" type="submit" [disabled]="isLoading || recipeForm.invalid || ingredientArray.length === 0 || instructionArray.length === 0 || mealArray.length === 0" class="px-5 py-2 submit-btn">
                <span *ngIf="!isLoading">{{ id ? 'UPDATE RECIPE' : 'PUBLISH RECIPE' }}</span>
                <mat-spinner diameter="20" *ngIf="isLoading" color="accent"></mat-spinner>
              </button>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>
